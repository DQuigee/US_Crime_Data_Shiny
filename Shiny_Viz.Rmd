---
title: "US Crime Data"
output: 
  flexdashboard::flex_dashboard:
    css: styles_Shiny.css
runtime: shiny
---


```{r Setup, include=FALSE}
# Loading necessary libraries
library(tidyverse)
library(RColorBrewer)
library(plotly)
library(maps)
library(httr)
library(shiny)
library(flexdashboard)
library(rgdal)
library(maptools)
library(sp)


knitr::opts_chunk$set(message = FALSE, warning = FALSE)


# Loading Data
load(file = "./data/Crime_In_US_By_State/data_state.RData")
load(file = "./data/Crime_In_US_By_Region/data_region.RData")
```



Crime Rates By State
===================================== 

Column {.sidebar data-width=310}
-----------------------------------------------------------------------

```{r Sidebar_Crime_Data_State}
crime_forms_state = c(
  "aggravated assault",
  "burglary",
  "larceny-theft",
  "motor vehicle theft",
  "murder and nonnegligent manslaughter",
  "rape",
  "robbery")
  
selectInput(
  "crime_form_state", 
  label = h3("Choose Type of Crime"),
  choices = as.list(crime_forms_state))
```

 

Column {.tabset}
-------------------------------------

### Map

```{r Map_State}
renderPlotly({

  col = colorRampPalette(brewer.pal(9, "BuPu"))(200)
  
  geo = list(
      scope = "usa",
      projection = list(type = "state"),
      showlakes = FALSE,
      lakecolor = toRGB("white"))
  
  altered_input_crime_form_state = str_replace_all(input$crime_form_state, " ", "_")
  altered_input_crime_form_state = str_replace_all(altered_input_crime_form_state, "-", "_")
  
  min_z = data_state %>% 
    filter(variable_name == paste(altered_input_crime_form_state, "_rate_per_100_000", sep = "")) %>%
    pull(statistic) %>% 
    min() %>% 
    floor()
  
  max_z = data_state %>% 
    filter(variable_name == paste(altered_input_crime_form_state, "_rate_per_100_000", sep = "")) %>%
    pull(statistic) %>% 
    max() %>% 
    ceiling()
  
  
  data_state %>%
    filter(variable_name == paste(altered_input_crime_form_state, "_rate_per_100_000", sep = "")) %>%
    plot_geo(locationmode = "USA-states") %>%
    add_trace(
      z = ~statistic,
      zmin = min_z,
      zmax = max_z,
      locations = ~state_code,
      color = ~statistic,
      colors = col,
      frame = ~year,
      text =  ~paste(
        paste("State: ", state, sep = ""),
        "\n" ,
        paste("Year: ", year, sep = ""), 
        sep = ""),
        hovertemplate = "%{text}\nStatistic: %{z}<extra></extra>") %>%
    layout(
      geo = geo,
      title = paste(
        "<b>\n", 
        input$crime_form_state, 
        " - rate per 100,000 people </b>", 
        sep = ""), 
      titlefont = list(size = 16)) %>%
    animation_opts(
      frame = 1200, 
      transition = 10,
      easing = "elastic", 
      redraw = TRUE)
})
```


### Time Plot

```{r Time_Plot_State}
states_available = data_state %>% 
  arrange(state) %>% 
  pull(state) %>% 
  unique()
states_available = c("All States", states_available)

selectInput(
  "state_chosen", 
  label = h3("Choose State"),
  choices = as.list(states_available))

renderPlotly({
  
  altered_input_crime_form_state = str_replace_all(input$crime_form_state, " ", "_")
  altered_input_crime_form_state = str_replace_all(altered_input_crime_form_state, "-", "_")

  if (input$state_chosen != "All States") {
  
    data_state %>%
      filter(state == input$state_chosen) %>%
      filter(variable_name == paste(altered_input_crime_form_state, "_rate_per_100_000", sep = "")) %>% 
      plot_ly(
        x = ~year, 
        y = ~statistic, 
        type = "scatter", 
        mode = 'lines+markers',
        alpha = 0.9,
        text =  ~paste("State: ", state, sep = ""),
        hovertemplate = "%{text}\nYear: %{x}\nStatistic: %{y}<extra></extra>") %>%
      layout(
        height = 450,
        xaxis = list(
          title = "Year",
          dtick = 2,
          tick0 = 1999,
          range = c(1998, 2019),
          tickmode = "linear",
          titlefont = list(size = 13),
          tickfont = list(size = 11)),
        yaxis = list(
          title = ~paste(input$crime_form_state, "\nrate per 100,000 people\n" ,sep = " "),
          titlefont = list(size = 13),
          tickfont = list(size = 11)),
        title =  ~paste("\n",input$state_chosen, "\n", sep = ""),
        titlefont = list(size = 17))
  }
  
  else {
    
    data_state %>%
      filter(variable_name == paste(altered_input_crime_form_state, "_rate_per_100_000", sep = "")) %>% 
      plot_ly(
        x = ~year, 
        y = ~statistic, 
        type = "scatter", 
        mode = 'lines+markers',
        alpha = 0.75,
        color = ~as.factor(state),
        text =  ~paste("State: ", state, sep = ""),
        hovertemplate = "%{text}\nYear: %{x}\nStatistic: %{y}<extra></extra>") %>%
      layout(
        height = 450,
        xaxis = list(
          title = "Year",
          dtick = 2,
          tick0 = 1999,
          range = c(1998, 2019),
          tickmode = "linear",
          titlefont = list(size = 13),
          tickfont = list(size = 11)),
        yaxis = list(
          title = ~paste(input$crime_form_state, "\nrate per 100,000 people\n" ,sep = " "),
          titlefont = list(size = 13),
          tickfont = list(size = 11)))
  }
})
```

### Data Source

<br>

Crime rates by state for the years 1999 to 2018 were retrieved from the FBI.

In particular, the data can be found on the following websites:

<br>

```{r}
renderTable({
  tibble(
    year = 2018:1999,
    source = c(
      "https://ucr.fbi.gov/crime-in-the-u.s/2018/crime-in-the-u.s.-2018/tables/table-5",
      "https://ucr.fbi.gov/crime-in-the-u.s/2017/crime-in-the-u.s.-2017/topic-pages/tables/table-5",
      "https://ucr.fbi.gov/crime-in-the-u.s/2016/crime-in-the-u.s.-2016/topic-pages/tables/table-3",
      "https://ucr.fbi.gov/crime-in-the-u.s/2015/crime-in-the-u.s.-2015/tables/table-5",
      "https://ucr.fbi.gov/crime-in-the-u.s/2014/crime-in-the-u.s.-2014/tables/table-5",
      "https://ucr.fbi.gov/crime-in-the-u.s/2013/crime-in-the-u.s.-2013/tables/5tabledatadecpdf",
      "https://ucr.fbi.gov/crime-in-the-u.s/2012/crime-in-the-u.s.-2012/tables/5tabledatadecpdf",
      "https://ucr.fbi.gov/crime-in-the-u.s/2011/crime-in-the-u.s.-2011/tables/table-5",
      "https://ucr.fbi.gov/crime-in-the-u.s/2010/crime-in-the-u.s.-2010/tables/10tbl05.xls",
      "https://www2.fbi.gov/ucr/cius2009/data/table_05.html",
      "https://www2.fbi.gov/ucr/cius2008/data/table_05.html",
      "https://www2.fbi.gov/ucr/cius2007/data/table_05.html",
      "https://www2.fbi.gov/ucr/cius2006/data/table_05.html",
      "https://www2.fbi.gov/ucr/05cius/data/table_05.html",
      "https://www2.fbi.gov/ucr/cius_04/offenses_reported/offense_tabulations/table_05.html",
      "https://ucr.fbi.gov/crime-in-the-u.s/2003    Choose   Table 5",
      "https://ucr.fbi.gov/crime-in-the-u.s/2002    Choose   Table 5",
      "https://ucr.fbi.gov/crime-in-the-u.s/2001    Choose   Table 5",
      "https://ucr.fbi.gov/crime-in-the-u.s/2000    Choose   Table 5",
      "https://ucr.fbi.gov/crime-in-the-u.s/1999    Choose   Table 5"))
})

```
 
 
 
Crime Rates By Regions / Divisions
===================================== 

Column {.sidebar data-width=310}
-----------------------------------------------------------------------

```{r Sidebar_Crime_Data_Region}
regions = c("Northeast", "Midwest", "South", "West")

divisions = c("New England", "Middle Atlantic",
              "East North Central", "West North Central",
              "South Atlantic", "East South Central", "West South Central",
              "Mountain", "Pacific")

regions = paste(
  regions[1], 
  regions[2], 
  regions[3], 
  regions[4], 
  sep = " - ")

divisions = paste(
  divisions[1],
  divisions[2],
  divisions[3],
  divisions[4],
  divisions[5],
  divisions[6],
  divisions[7],
  divisions[8],
  divisions[9],
  sep = " - ")

region_types = c(regions, divisions)


selectInput(
  "region_type", 
  label = h3("Choose between Regions and Divisions"),
  choices = as.list(region_types))


crime_formes_region = c(
  "aggravated assault",
  "burglary",
  "larceny-theft",
  "motor vehicle theft",
  "murder and nonnegligent manslaughter",
  "rape",
  "robbery")
  
selectInput(
  "crime_form_region", 
  label = h3("Choose Type of Crime"),
  choices = as.list(crime_formes_region))
```


Column {.tabset}
-------------------------------------

### Map

```{r Map_Region}
renderPlotly({

  if (input$region_type == regions) {
    data_region_plot = data_region %>% 
      filter(region == "Northeast" | region == "Midwest" | region == "South" | region == "West")
  }
  else { 
    data_region_plot = data_region %>% 
      filter(region != "Northeast" & region != "Midwest" & region != "South" & region != "West")
  }
  

  col = colorRampPalette(brewer.pal(9, "BuPu"))(200)
  
  geo = list(
      scope = "usa",
      projection = list(type = "state"),
      showlakes = FALSE,
      lakecolor = toRGB("white"))
  
  altered_input_crime_form_region = str_replace_all(input$crime_form_region, " ", "_")
  altered_input_crime_form_region = str_replace_all(altered_input_crime_form_region, "-", "_")
  
  min_z = data_region_plot %>% 
    filter(variable_name == paste(altered_input_crime_form_region, "_rate_per_100_000", sep = "")) %>%
    pull(statistic) %>% 
    min() %>% 
    floor()
  
  max_z = data_region_plot %>% 
    filter(variable_name == paste(altered_input_crime_form_region, "_rate_per_100_000", sep = "")) %>%
    pull(statistic) %>% 
    max() %>% 
    ceiling()
  
  data_region_plot %>%
    filter(variable_name == paste(altered_input_crime_form_region, "_rate_per_100_000", sep = "")) %>% 
    plot_geo(locationmode = "USA-states") %>%
    add_trace(
      z = ~statistic,
      zmin = min_z,
      zmax = max_z,
      locations = ~state_code,
      color = ~statistic,
      colors = col,
      frame = ~year,
      text =  ~paste(
        paste("Region: ", region, sep = ""),
        "\n" ,
        paste("Year: ", year, sep = ""), 
        sep = ""),
        hovertemplate = "%{text}\nStatistic: %{z}<extra></extra>") %>%
    layout(
      geo = geo,
      title = paste(
        "<b>\n", 
        input$crime_form_region, 
        " - rate per 100,000 people </b>", 
        sep = ""), 
      titlefont = list(size = 16)) %>%
      animation_opts(
        frame = 1200, 
        transition = 10,
        easing = "elastic", 
        redraw = TRUE)
})
```


### Time Plot

```{r Time_Plot_Region}
renderPlotly({
  
  altered_input_crime_form_region = str_replace_all(input$crime_form_region, " ", "_")
  altered_input_crime_form_region = str_replace_all(altered_input_crime_form_region, "-", "_")


  if (input$region_type == regions) {
    data_region_plot = data_region %>% 
      filter(region == "Northeast" | region == "Midwest" | region == "South" | region == "West")
  }
  else { 
    data_region_plot = data_region %>% 
      filter(region != "Northeast" & region != "Midwest" & region != "South" & region != "West")
  }
  
  data_region_plot %>%
    select(-state, -state_code) %>%
    filter(variable_name == paste(altered_input_crime_form_region, "_rate_per_100_000", sep = "")) %>% 
    distinct() %>% 
    group_by(region) %>% 
    plot_ly(
      x = ~year, 
      y = ~statistic, 
      type = "scatter", 
      mode = 'lines+markers',
      alpha = 0.75,
      color = ~as.factor(region),
      text =  ~paste("Region: ", region, sep = ""),
      hovertemplate = "%{text}\nYear: %{x}\nStatistic: %{y}<extra></extra>") %>%
    layout(
      xaxis = list(
        title = "Year",
        dtick = 2,
        tick0 = 1999,
        range = c(1998, 2019),
        tickmode = "linear",
        titlefont = list(size = 13),
        tickfont = list(size = 11)),
      yaxis = list(
        title = ~paste(input$crime_form_region, "\nrate per 100,000 people\n" ,sep = " "),
        titlefont = list(size = 13),
        tickfont = list(size = 11)))
})
```


 
### Data Source

<br>

<br>
 
```{r}
renderTable({
tibble(
  year = 2018:2016,
  source = c(
    "https://ucr.fbi.gov/crime-in-the-u.s/2018/crime-in-the-u.s.-2018/tables/table-4",
    "https://ucr.fbi.gov/crime-in-the-u.s/2017/crime-in-the-u.s.-2017/tables/table-4",
    "https://ucr.fbi.gov/crime-in-the-u.s/2016/crime-in-the-u.s.-2016/topic-pages/tables/table-2"
  )
)
})

```
 
Clearance Rates By Regions / Divisions
===================================== 


Column {.sidebar data-width=310}
-----------------------------------------------------------------------

```{r Sidebar_Clearance_Region}

```



Column {.tabset}
-------------------------------------

### Map

```{r Map_Region_Clearance}


```


 
### Time Plot

```{r Time_plot_Region_Clearance}
 
 
```



Murder Weapons By State
===================================== 


Column {.sidebar data-width=310}
-----------------------------------------------------------------------

```{r Sidebar_Murder_Weapon}


```




Column {data-width=800}
-------------------------------------
    
### 
    
```{r Murder_Weapon_Plot}


```
 
 
 
 
NYC Crime Rates 
===================================== 


Column {.sidebar data-width=310}
-----------------------------------------------------------------------

```{r Sidebar_Crime_Data_NYC}


```



Column {.tabset}
-------------------------------------

### Map

```{r Map_NYC}


```

### Time Plot
 
```{r Time_Plot_NYC}


```


About 
=====================================
